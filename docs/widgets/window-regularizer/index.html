<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Window Regularizer Interactive Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- KaTeX for rendering mathematical formulas -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" xintegrity="sha384-n8MVd4RsNIU0KOVEMGmJoZBTT7SgX1PzxIe1LCan4QM5KIrvDAotTtJeNldvXotY" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" xintegrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" xintegrity="sha384-+VBxd3r6XgURPiLgZso9PbyEXdLs2STvxKI3o7qaUGeZQ1eAiOLoFRG8ldMZXz2x" crossorigin="anonymous"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        /* --- Base & Animation Styles --- */
        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            transition: background 1.5s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        
        :root {
            --bg-color: #f8fafc;
            --light-shadow: rgba(255, 255, 255, 1);
            --dark-shadow: rgba(148, 163, 184, 0.3);
            --ease-out-quad: cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --ease-out-cubic: cubic-bezier(0.215, 0.610, 0.355, 1.000);
        }

        /* --- Neumorphic Page Container --- */
        .neumorphic-page-container {
            background: var(--bg-color);
            border-radius: 25px;
            box-shadow: 0 0 24px var(--dark-shadow);
            margin: 1rem;
            padding: 2rem;
            min-height: calc(100vh - 2rem);
            position: relative;
        }

        .neumorphic-content {
            position: relative;
            z-index: 1;
        }

        /* --- Neumorphic Card Style --- */
        .interactive-card {
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            box-shadow: 8px 8px 16px var(--dark-shadow), -8px -8px 16px var(--light-shadow);
            transition: transform 0.35s var(--ease-out-cubic), 
                        box-shadow 0.35s var(--ease-out-cubic), 
                        border-color 0.35s var(--ease-out-cubic);
            will-change: transform, box-shadow;
        }
        .interactive-card:hover {
            box-shadow: 12px 12px 24px var(--dark-shadow), -12px -12px 24px var(--light-shadow);
            transform: translateY(-5px);
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        .demo-card { 
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.75) 0%, rgba(248, 250, 252, 0.65) 100%); 
            border-color: rgba(226, 232, 240, 0.8); 
            border-left: 3px solid #0d9488; 
            border-radius: 20px;
            box-shadow: 8px 8px 16px var(--dark-shadow), -8px -8px 16px var(--light-shadow), 0 2px 8px rgba(0, 0, 0, 0.06), 0 1px 3px rgba(0, 0, 0, 0.04);
        }
        .intro-card { 
            background: linear-gradient(135deg, rgba(254, 252, 232, 0.6) 0%, rgba(254, 243, 199, 0.5) 100%); 
            border-color: rgba(251, 191, 36, 0.5);
            border-radius: 20px;
            box-shadow: 8px 8px 16px var(--dark-shadow), -8px -8px 16px var(--light-shadow);
        }
        .metrics-card { 
            background: linear-gradient(135deg, rgba(240, 249, 255, 0.6) 0%, rgba(219, 234, 254, 0.5) 100%); 
            border-color: rgba(147, 197, 253, 0.6);
            border-radius: 20px;
            box-shadow: 8px 8px 16px var(--dark-shadow), -8px -8px 16px var(--light-shadow);
        }
        .formula-card { 
            background: linear-gradient(135deg, rgba(245, 243, 255, 0.6) 0%, rgba(237, 233, 254, 0.5) 100%); 
            border-color: rgba(196, 181, 253, 0.6);
            border-radius: 20px;
            box-shadow: 8px 8px 16px var(--dark-shadow), -8px -8px 16px var(--light-shadow);
        }

        /* --- UI Component Styles --- */
        .axis-label { position: absolute; font-size: 0.75rem; color: #475569; font-weight: 500; white-space: nowrap; z-index: 25; }
        .ideal-mapping-window { position: absolute; border: 2px solid #0d9488; background-color: rgba(20, 184, 166, 0.3); box-sizing: border-box; z-index: 1; transition: left 0.4s var(--ease-out-cubic), bottom 0.4s var(--ease-out-cubic), width 0.4s var(--ease-out-cubic), height 0.4s var(--ease-out-cubic), background-color 0.25s var(--ease-out-cubic), border-color 0.25s var(--ease-out-cubic), box-shadow 0.25s var(--ease-out-cubic); pointer-events: none; border-radius: 0.375rem; box-shadow: 0 0 8px rgba(13, 148, 136, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.2); outline: 1px solid #0d9488; outline-offset: -1px; }
        .chart-grid-background {
            background-color: #fafbfc;
            border-radius: 15px;
            box-shadow: inset 5px 5px 10px var(--dark-shadow), inset -5px -5px 10px var(--light-shadow), inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        .grid-line {
            position: absolute;
            background-color: #e2e8f0;
            z-index: 0;
            pointer-events: none;
        }
        
        .bar-item { margin-bottom: 12px; }
        .bar-item:last-child { margin-bottom: 0; }
        .bar-label-value { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; font-size: 0.875rem; }
        .bar-label-value .label { color: #475569; font-weight: 500; }
        .bar-label-value .value-text { color: #1e293b; font-weight: 600; background-color: rgba(241, 245, 249, 0.7); padding: 3px 8px; border-radius: 6px; font-size: 0.8rem; }
        .bar-wrapper { width: 100%; height: 20px; background-color: #e2e8f0; border-radius: 6px; overflow: hidden; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); }
        .bar { height: 100%; border-radius: 6px; transition: width 0.4s ease-out; text-align: right; color: white; font-size: 0.75rem; line-height: 20px; font-weight: 500; }

        #timelineAreaBar { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); }
        #totalMappingWindowAreaBar { background: linear-gradient(135deg, #10b981 0%, #34d399 100%); }
        #minAreaBar { background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); }
        #windowRegularizerBar { background: linear-gradient(135deg, #ef4444 0%, #f87171 100%); }
        #originalNasBar { background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%); }
        #regularizedNasBar { background: linear-gradient(135deg, #059669 0%, #10b981 100%); font-weight: 600; }

        /* --- Neumorphic Input & Button Styles --- */
        .neumorphic-input {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            box-shadow: inset 4px 4px 8px var(--dark-shadow), inset -4px -4px 8px var(--light-shadow);
            padding: 0.75rem;
            font-size: 0.875rem;
            transition: box-shadow 0.3s var(--ease-out-quad), border-color 0.3s var(--ease-out-quad);
            color: #374151;
        }
        .neumorphic-input:focus {
            outline: none;
            box-shadow: inset 6px 6px 12px var(--dark-shadow), inset -6px -6px 12px var(--light-shadow);
            border-color: #0d9488;
        }

        .neumorphic-btn {
            border-radius: 12px;
            background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%);
            color: white;
            font-weight: 600;
            box-shadow: 5px 5px 10px var(--dark-shadow), -5px -5px 10px var(--light-shadow);
            transition: all 0.2s var(--ease-out-quad);
            border: none;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        .neumorphic-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }
        .neumorphic-btn:hover {
            box-shadow: 6px 6px 12px var(--dark-shadow), -6px -6px 12px var(--light-shadow);
            transform: translateY(-1px) scale(1.02);
        }
        .neumorphic-btn:hover::before {
            left: 100%;
        }
        .neumorphic-btn:active {
            box-shadow: inset 4px 4px 8px var(--dark-shadow), inset -4px -4px 8px var(--light-shadow);
            transform: translateY(1px);
        }
        .neumorphic-btn.primary {
            background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%);
        }

        .preset-btn { 
            border-radius: 12px;
            background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%);
            color: white;
            font-weight: 600;
            box-shadow: 5px 5px 10px var(--dark-shadow), -5px -5px 10px var(--light-shadow);
            transition: all 0.2s var(--ease-out-quad);
            border: none;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .preset-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }
        .preset-btn:hover {
            box-shadow: 6px 6px 12px var(--dark-shadow), -6px -6px 12px var(--light-shadow);
            transform: translateY(-1px) scale(1.02);
        }
        .preset-btn:active {
            box-shadow: inset 4px 4px 8px var(--dark-shadow), inset -4px -4px 8px var(--light-shadow);
            transform: translateY(1px);
        }
        .preset-btn:hover::before {
            left: 100%;
        }
        .preset-btn:hover i {
            transform: scale(1.1);
        }
        .preset-btn i {
            transition: all 0.3s ease;
        }

        /* --- Styles for Algorithm Details --- */
        .math-formula { background: rgba(248, 250, 252, 0.8); border: 1px solid #e2e8f0; font-family: 'Inter', sans-serif; font-size: 1rem; }
        .step-number { background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; width: 2rem; height: 2rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.875rem; flex-shrink: 0; }
        details summary { cursor: pointer; user-select: none; transition: color 0.2s var(--ease-out-quad); }
        details summary:hover { color: #1d4ed8; }
        details summary::-webkit-details-marker { display: none; }
        details summary .summary-icon { display: inline-block; margin-right: 0.5rem; transition: transform 0.25s var(--ease-out-cubic); }
        details[open] summary .summary-icon { transform: rotate(90deg); }

        /* --- Tour Styles --- */
        #tour-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9998; opacity: 0; transition: opacity 0.4s ease-in-out; pointer-events: none; }
        .tour-highlight { position: relative; z-index: 9999; box-shadow: 0 0 0 9999px rgba(0,0,0,0.6), 0 0 20px rgba(255, 255, 255, 0.9); border-radius: 0.5rem; transition: box-shadow 0.4s ease-in-out; }
        #tour-callout { 
            position: absolute; 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            color: #334155; 
            padding: 1.25rem; 
            border-radius: 20px; 
            box-shadow: 8px 8px 16px var(--dark-shadow), -8px -8px 16px var(--light-shadow);
            z-index: 10000; 
            max-width: 320px; 
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: opacity 0.3s var(--ease-out-cubic), transform 0.3s var(--ease-out-cubic); 
            transform: translateY(10px); 
            opacity: 0; 
        }
        #tour-callout.visible { transform: translateY(0); opacity: 1; }
        #tour-callout button { 
            background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%); 
            color: white; 
            padding: 0.5rem 1rem; 
            border: none; 
            border-radius: 12px; 
            cursor: pointer; 
            font-weight: 600;
            box-shadow: 4px 4px 8px var(--dark-shadow), -4px -4px 8px var(--light-shadow);
            transition: all 0.2s var(--ease-out-quad);
        }
        #tour-callout button:hover { 
            box-shadow: 6px 6px 12px var(--dark-shadow), -6px -6px 12px var(--light-shadow);
            transform: translateY(-1px) scale(1.02); 
        }

        /* --- Testing Modal Styles --- */
        .testing-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.4) 0%, rgba(0, 0, 0, 0.7) 100%);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s var(--ease-out-cubic);
        }
        .testing-modal.visible {
            opacity: 1;
            visibility: visible;
        }
        .testing-modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            padding: 2.5rem;
            max-width: 90vw;
            max-height: 85vh;
            width: 700px;
            box-shadow: 
                12px 12px 24px var(--dark-shadow), 
                -12px -12px 24px var(--light-shadow),
                0 8px 32px rgba(0, 0, 0, 0.1);
            transform: translateY(30px) scale(0.9);
            transition: all 0.5s var(--ease-out-cubic);
            overflow-y: auto;
            box-sizing: border-box;
            position: relative;
        }
        /* Custom scrollbar for testing modal */
        .testing-modal-content::-webkit-scrollbar {
            width: 8px;
        }
        .testing-modal-content::-webkit-scrollbar-track {
            background: rgba(248, 250, 252, 0.3);
            border-radius: 1rem;
        }
        .testing-modal-content::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, rgba(13, 148, 136, 0.6) 0%, rgba(20, 184, 166, 0.4) 100%);
            border-radius: 1rem;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        .testing-modal-content::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, rgba(13, 148, 136, 0.8) 0%, rgba(20, 184, 166, 0.6) 100%);
        }
        /* Firefox scrollbar styling */
        .testing-modal-content {
            scrollbar-width: thin;
            scrollbar-color: rgba(13, 148, 136, 0.6) rgba(248, 250, 252, 0.3);
        }
        .testing-modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent 0%, rgba(13, 148, 136, 0.8) 50%, transparent 100%);
        }
        .testing-modal.visible .testing-modal-content {
            transform: translateY(0) scale(1);
        }
        .testing-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid rgba(226, 232, 240, 0.6);
            position: relative;
        }
        .testing-modal-header::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 60px;
            height: 2px;
            background: linear-gradient(90deg, #0d9488 0%, #14b8a6 100%);
            border-radius: 1px;
        }
        .testing-modal-close {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            font-size: 1.25rem;
            cursor: pointer;
            color: #64748b;
            padding: 0.75rem;
            border-radius: 50%;
            box-shadow: 4px 4px 8px var(--dark-shadow), -4px -4px 8px var(--light-shadow);
            transition: all 0.3s var(--ease-out-cubic);
            width: 3rem;
            height: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .testing-modal-close:hover {
            color: #0d9488;
            transform: rotate(90deg) scale(1.1);
            box-shadow: 6px 6px 12px var(--dark-shadow), -6px -6px 12px var(--light-shadow);
        }
        .test-category {
            margin-bottom: 2rem;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            box-shadow: 6px 6px 12px var(--dark-shadow), -6px -6px 12px var(--light-shadow);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        .test-category::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(20, 184, 166, 0.05) 0%, rgba(15, 118, 110, 0.05) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .test-category:hover::before {
            opacity: 1;
        }
        .test-category:hover {
            transform: translateY(-2px);
            box-shadow: 8px 8px 16px var(--dark-shadow), -8px -8px 16px var(--light-shadow);
        }
        .test-category h3 {
            color: #0f172a;
            margin-bottom: 1.5rem;
            font-size: 1.25rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            letter-spacing: -0.025em;
        }
        .test-category h3 i {
            margin-right: 0.75rem;
            color: #0d9488;
            background: linear-gradient(135deg, #e6fffa 0%, #b2f5ea 100%);
            padding: 0.5rem;
            border-radius: 50%;
            font-size: 1rem;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            position: relative;
        }
        .test-category:hover h3 i {
            transform: translateY(-2px) scale(1.1);
            box-shadow: 
                0 8px 16px rgba(20, 184, 166, 0.3),
                0 4px 8px rgba(255, 255, 255, 0.9) inset;
            color: #0f766e;
        }
        .test-item {
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 4px 4px 8px var(--dark-shadow), -4px -4px 8px var(--light-shadow);
            transition: all 0.2s var(--ease-out-quad);
        }
        .test-item:hover {
            transform: translateY(-1px);
            box-shadow: 6px 6px 12px var(--dark-shadow), -6px -6px 12px var(--light-shadow);
        }
        .test-item:last-child {
            margin-bottom: 0;
        }
        .test-item h4 {
            color: #1e293b;
            margin-bottom: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            letter-spacing: -0.025em;
        }
        .test-item p {
            color: #475569;
            font-size: 0.875rem;
            line-height: 1.6;
            margin-bottom: 1rem;
        }
        .test-checklist {
            list-style: none;
            padding: 0;
            margin: 0;
            background: rgba(248, 250, 252, 0.4);
            border-radius: 0.5rem;
            padding: 1rem;
            border: 1px solid rgba(226, 232, 240, 0.4);
        }
        .test-checklist li {
            margin-bottom: 0.75rem;
            display: flex;
            align-items: flex-start;
            font-size: 0.875rem;
            color: #334155;
            line-height: 1.5;
            transition: all 0.2s var(--ease-out-quad);
        }
        .test-checklist li:last-child {
            margin-bottom: 0;
        }
        .test-checklist li:hover {
            color: #0d9488;
            transform: translateX(2px);
        }
        .test-checklist li::before {
            content: "‚úì";
            margin-right: 0.75rem;
            color: #0d9488;
            font-weight: bold;
            background: rgba(13, 148, 136, 0.1);
            border-radius: 50%;
            width: 1.25rem;
            height: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            flex-shrink: 0;
            margin-top: 0.125rem;
        }
        .action-button {
            background: linear-gradient(135deg, #0d9488 0%, #14b8a6 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s var(--ease-out-cubic);
            margin-right: 0.75rem;
            margin-top: 1rem;
            box-shadow: 0 2px 8px rgba(13, 148, 136, 0.2);
            position: relative;
            overflow: hidden;
        }
        .action-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.2) 50%, transparent 100%);
            transition: left 0.5s var(--ease-out-quad);
        }
        .action-button:hover::before {
            left: 100%;
        }
        .action-button:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 6px 20px rgba(13, 148, 136, 0.3);
        }
        .action-button:active {
            transform: translateY(-1px) scale(1);
        }

        /* --- NEW Styles for Chart Resizing and Penalty Attribution --- */
        .resize-handle { position: absolute; background: rgba(13, 148, 136, 0.5); opacity: 0; transition: opacity 0.3s ease; z-index: 30; }
        .resize-handle:hover { opacity: 1; }
        #resizeHandleX { top: 0; right: -5px; width: 10px; height: 100%; cursor: ew-resize; }
        #resizeHandleY { top: -5px; left: 0; width: 100%; height: 10px; cursor: ns-resize; }
        
        .penalty-highlight-active .ideal-mapping-window {
            background-color: rgba(239, 68, 68, 0.4);
            border-color: #ef4444;
            animation: pulse-red 1.5s infinite;
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.5); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        /* --- Hero Section Styles --- */
        #hero-section {
            background: linear-gradient(45deg, #0d9488, #0f766e); 
            color: white;
            border-radius: 20px 20px 0 0; /* Top corners rounded, bottom corners square */
        }
        #hero-section h1 {
            text-shadow: 1px 1px 3px rgba(0,0,0,0.2); 
        }

        /* --- Hero Tour Button (No White Glow) --- */
        .hero-tour-btn {
            background: linear-gradient(135deg, #0f766e 0%, #064e3b 100%);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.75rem;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }

        .hero-tour-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.15), transparent);
            transition: left 0.5s ease;
        }

        .hero-tour-btn:hover {
            background: linear-gradient(135deg, #14b8a6 0%, #0f766e 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .hero-tour-btn:hover::before {
            left: 100%;
        }

        .hero-tour-btn:active {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.5);
        }

        /* Math container styling */
        .math-container {
            background: #dbeafe;
            border: 1px solid #93c5fd;
            border-radius: 0.75rem;
            padding: 0.75rem;
            margin-top: 0.75rem;
        }

        /* KaTeX color overrides */
        .katex {
            color: #1e40af !important;
        }

        .katex .mord,
        .katex .mop,
        .katex .mbin,
        .katex .mrel,
        .katex .mopen,
        .katex .mclose,
        .katex .mpunct {
            color: #1e40af !important;
        }

        .katex .mtext {
            color: #1e3a8a !important;
        }
    </style>
</head>
<body class="h-full text-slate-700 antialiased">
    <div id="app-background" class="fixed inset-0 z-[-1] transition-all duration-1000"></div>
    <div id="tour-overlay"></div>

    <div class="neumorphic-page-container">
        <div class="neumorphic-content">
            <article class="interactive-card">
                <!-- Hero Section -->
                <section id="hero-section" class="py-6 px-4 sm:px-6 lg:px-8 relative">
                    <div class="container mx-auto">
                        <!-- Start Tour Button - Top Right -->
                        <button id="start-tour-btn" class="hero-tour-btn absolute top-4 right-4 py-2 px-4">
                            <i class="fas fa-magic mr-2"></i>Start Tour
                        </button>
                        
                        <div class="text-left max-w-4xl">
                            <div class="flex items-center justify-start mb-4">
                                <div class="bg-teal-200 text-teal-800 px-3 py-1 rounded-full text-xs font-semibold uppercase tracking-wide mr-2">Interactive Demo</div>
                                <div class="bg-white bg-opacity-20 text-white px-3 py-1 rounded-full text-xs font-semibold">Core VCS Component</div>
                            </div>
                            <h1 class="text-3xl sm:text-4xl lg:text-5xl font-extrabold text-white mb-3 leading-tight">
                                Window Regularizer
                            </h1>
                            <p class="text-teal-200 text-base sm:text-lg mb-6 max-w-3xl">
                                Explore how the Window Regularizer prevents excessive mapping window coverage to ensure balanced narrative assessment in the Video Comprehension Score framework.
                            </p>
                        </div>
                    </div>
                </section>

                <!-- Main Container -->
                <main class="w-full max-w-7xl mx-auto p-6">

        <!-- Introduction Section -->
        <div id="tour-step-intro" class="intro-card interactive-card rounded-xl p-6 mb-8">
            <div class="flex items-center mb-4"><i class="fas fa-lightbulb text-amber-600 text-xl mr-3"></i><h2 class="text-xl font-semibold text-amber-800">Introduction to Window Regularizer</h2></div>
            
            <!-- Definition -->
            <div class="bg-white bg-opacity-70 p-4 rounded-xl mb-6 border-l-4 border-amber-500">
                <p class="text-sm text-slate-700 mb-3"><strong>What is the Window Regularizer?</strong> The Window Regularizer is a penalty function that addresses a critical issue in text comparison: when one text is much shorter than another, the mapping windows become excessively large, making the assessment overly permissive and yielding artificially high scores. It measures the ratio of window coverage to total area and applies penalties when coverage is excessive.</p>
                
                <!-- Warning -->
                <div class="bg-orange-50 border border-orange-200 rounded-xl p-3 mt-3">
                    <div class="flex items-start">
                        <i class="fas fa-exclamation-triangle text-orange-500 mr-2 mt-0.5"></i>
                        <div>
                            <p class="text-xs text-orange-800 font-medium mb-1">‚ö†Ô∏è Prerequisites Required</p>
                            <p class="text-xs text-orange-700">Please read the VCS research paper and understand the theoretical foundation of Window Regularizer before using this interactive demo. This visualization assumes familiarity with the underlying concepts.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Additional Prerequisites -->
                <div class="bg-blue-50 border border-blue-200 rounded-xl p-3 mt-3">
                    <div class="flex items-start">
                        <i class="fas fa-info-circle text-blue-500 mr-2 mt-0.5"></i>
                        <div>
                            <p class="text-xs text-blue-800 font-medium mb-1">üìö Additional Prerequisites</p>
                            <p class="text-xs text-blue-700">Before exploring Window Regularizer, we recommend visiting the <a href="../distance-nas/" class="font-bold underline hover:text-blue-900">Distance-based NAS Demo</a> and <a href="../line-nas/" class="font-bold underline hover:text-blue-900">Line-based NAS Demo</a>. To understand the specific problem this solves, check the "Low Dimensionality Problem" in the Testing Guide under Manual Exploration section in those demos, then return here to see how Window Regularizer addresses this issue.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="bg-white bg-opacity-60 p-4 rounded-xl"><h4 class="font-semibold text-amber-700 mb-2 flex items-center"><i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>The Problem</h4><p class="text-sm text-slate-700">Large text length imbalances create oversized mapping windows, leading to overly permissive alignments and inflated similarity scores.</p></div>
                <div class="bg-white bg-opacity-60 p-4 rounded-xl"><h4 class="font-semibold text-amber-700 mb-2 flex items-center"><i class="fas fa-balance-scale text-teal-500 mr-2"></i>The Solution</h4><p class="text-sm text-slate-700">Regularization penalizes excessive window coverage relative to the total grid area, ensuring fair assessment regardless of text length ratios.</p></div>
                <div class="bg-white bg-opacity-60 p-4 rounded-xl"><h4 class="font-semibold text-amber-700 mb-2 flex items-center"><i class="fas fa-chart-line text-blue-500 mr-2"></i>The Result</h4><p class="text-sm text-slate-700">More stringent and reliable similarity scores that accurately reflect narrative alignment quality, especially for unbalanced text pairs.</p></div>
            </div>
            <details id="tour-step-algo" class="mb-4">
                <summary class="font-semibold text-amber-700 mb-3 flex items-center"><i class="fas fa-chevron-right summary-icon"></i>Window Regularizer Algorithm</summary>
                <div class="mt-4 space-y-4">
                    <!-- Main Algorithm Overview -->
                    <div class="bg-white bg-opacity-70 p-4 rounded-lg border-l-4 border-amber-500">
                        <p class="text-sm text-slate-700 mb-3"><strong>Algorithm Overview:</strong> The Window Regularizer algorithm follows 3 steps to penalize excessive mapping window coverage that leads to overly permissive alignments. Unlike NAS components, regularization operates on the unified mapping window structure since precision and recall windows are axis-flipped versions of the same constraint:</p>
                        
                        <!-- Step 1: Calculate Coverage Areas -->
                        <div class="bg-orange-50 border border-orange-200 rounded-xl p-3 mt-3">
                            <div class="flex items-start">
                                <i class="fas fa-chart-area text-orange-500 mr-2 mt-0.5"></i>
                                <div>
                                    <p class="text-xs text-orange-800 font-medium mb-1">Step 1: Calculate Coverage Areas</p>
                                    <p class="text-xs text-orange-700 mb-2">Compute the total grid area and the cumulative area covered by all mapping windows to determine the coverage ratio that measures alignment permissiveness.</p>
                                    <div class="math-container">
                                        <p class="text-xs">$\text{timeline\_area} = N_{ref} \times N_{gen}$</p>
                                        <p class="text-xs">$\text{total\_mapping\_window\_area} = \sum_{i=0}^{|\text{windows}|-1} (\text{end}_i - \text{start}_i) \times 1$</p>
                                        <p class="text-xs">$\text{coverage\_ratio} = \frac{\text{total\_mapping\_window\_area}}{\text{timeline\_area}}$</p>
                                    </div>
                                    <p class="text-xs text-orange-700 mt-2">Higher coverage ratios indicate more permissive alignments that may lead to inflated similarity scores.</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Step 3: Compute Minimum Coverage Threshold -->
                        <div class="bg-orange-50 border border-orange-200 rounded-xl p-3 mt-3">
                            <div class="flex items-start">
                                <i class="fas fa-ruler-horizontal text-orange-500 mr-2 mt-0.5"></i>
                                <div>
                                    <p class="text-xs text-orange-800 font-medium mb-1">Step 2: Compute Minimum Coverage Threshold</p>
                                    <p class="text-xs text-orange-700 mb-2">Calculate the ideal minimum coverage ratio representing perfect 1:1 mapping with no window overlap, serving as the baseline for penalty calculation.</p>
                                    <div class="math-container">
                                        <p class="text-xs">$\text{min\_area} = \begin{cases} 
                                        \frac{1}{N_{ref}} & \text{if } N_{ref} > N_{gen} \\
                                        \frac{1}{N_{gen}} & \text{if } N_{gen} \geq N_{ref}
                                        \end{cases}$</p>
                                    </div>
                                    <p class="text-xs text-orange-700 mt-2">This represents the theoretical minimum coverage for perfect sequential alignment without any window overlap.</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Step 4: Calculate Regularization Penalty -->
                        <div class="bg-orange-50 border border-orange-200 rounded-xl p-3 mt-3">
                            <div class="flex items-start">
                                <i class="fas fa-balance-scale text-orange-500 mr-2 mt-0.5"></i>
                                <div>
                                    <p class="text-xs text-orange-800 font-medium mb-1">Step 3: Calculate Regularization Penalty and Apply to NAS</p>
                                    <p class="text-xs text-orange-700 mb-2">Compute the window regularizer penalty based on coverage excess and apply it to the original NAS score with renormalization to produce the final regularized score.</p>
                                    <div class="math-container">
                                        <p class="text-xs">$\text{raw\_penalty} = \frac{\text{coverage\_ratio} - \text{min\_area}}{0.5 - \text{min\_area}}$</p>
                                        <p class="text-xs">$\text{window\_regularizer} = \max(0, \min(1, \text{raw\_penalty}))$</p>
                                        <p class="text-xs">$\text{regularized\_nas} = \begin{cases} 
                                        \frac{\text{nas\_f1} - \text{window\_regularizer}}{1 - \text{window\_regularizer}} & \text{if } \text{nas\_f1} > \text{window\_regularizer} \\
                                        0 & \text{otherwise}
                                        \end{cases}$</p>
                                    </div>
                                    <p class="text-xs text-orange-700 mt-2">The penalty increases with excessive window coverage, and renormalization ensures fair comparison across different text length ratios.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Algorithm Conclusion -->
                        <div class="bg-blue-50 border border-blue-200 rounded-xl p-3 mt-3">
                            <div class="flex items-start">
                                <i class="fas fa-play-circle text-blue-500 mr-2 mt-0.5"></i>
                                <div>
                                    <p class="text-xs text-blue-800 font-medium mb-1">üéØ Interactive Demo</p>
                                    <p class="text-xs text-blue-700 mb-2">Now that you understand how Window Regularizer penalizes excessive mapping window coverage to prevent inflated similarity scores, use the interactive demo below to see how different text length ratios affect window coverage and regularization penalties.</p>
                                    <p class="text-xs text-blue-700">Observe how larger length imbalances create more permissive windows that require stronger regularization to maintain fair assessment quality.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </details>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 space-y-8">
                <div id="tour-step-2" class="demo-card interactive-card rounded-xl p-4">
                    <div class="text-center mb-4">
                        <div class="inline-flex items-center bg-teal-100 text-teal-800 px-3 py-1 rounded-full text-xs font-semibold mb-2"><i class="fas fa-chart-area mr-1"></i>WINDOW COVERAGE VISUALIZATION</div>
                        <h2 class="text-lg font-bold text-slate-800">Mapping Window Coverage Analysis</h2>
                    </div>
                    <div class="relative w-full max-w-2xl mx-auto pt-4 pb-20 pl-16 pr-4">
                        <div class="absolute top-1/2 -left-12 -translate-y-1/2 -rotate-90 font-semibold text-sm text-slate-600 whitespace-nowrap">Reference Chunks</div>
                        <div class="absolute bottom-2 left-1/2 -translate-x-1/2 font-semibold text-sm text-slate-600">Generated Chunks</div>
                        <div id="chartContainer" class="relative w-full aspect-square">
                            <div id="chartGrid" class="absolute inset-0 bg-white rounded-xl chart-grid-background border border-slate-200">
                                <div id="idealMappingContainer"></div>
                                <div id="axisLabelContainerY"></div>
                                <div id="axisLabelContainerX"></div>
                            </div>
                            <!-- NEW Resize Handles -->
                            <div id="resizeHandleX" class="resize-handle"></div>
                            <div id="resizeHandleY" class="resize-handle"></div>
                        </div>
                    </div>
                </div>

                <div id="tour-step-4" class="formula-card interactive-card rounded-xl p-6">
                    <h3 class="text-lg font-semibold text-purple-800 mb-4 flex items-center"><i class="fas fa-chart-bar text-purple-600 mr-2"></i>Regularization Metrics Breakdown</h3>
                    <div class="space-y-4">
                        <div class="bar-item"><div class="bar-label-value"><span class="label">Timeline Area (TR √ó TG):</span><span class="value-text" id="timelineAreaValText">-</span></div><div class="bar-wrapper"><div class="bar" id="timelineAreaBar" style="width: 0%;"></div></div></div>
                        <div class="bar-item"><div class="bar-label-value"><span class="label">Total Mapping Window Area:</span><span class="value-text" id="totalMappingWindowAreaValText">-</span></div><div class="bar-wrapper"><div class="bar" id="totalMappingWindowAreaBar" style="width: 0%;"></div></div></div>
                        <div class="bar-item"><div class="bar-label-value"><span class="label">Min Area (1/max(TR,TG)):</span><span class="value-text" id="minAreaValText">-</span></div><div class="bar-wrapper"><div class="bar" id="minAreaBar" style="width: 0%;"></div></div></div>
                        <div id="penalty-bar-container" class="bar-item"><div class="bar-label-value"><span class="label">Window Regularizer Penalty:</span><span class="value-text" id="windowRegularizerValText">-</span></div><div class="bar-wrapper"><div class="bar" id="windowRegularizerBar" style="width: 0%;"></div></div></div>
                        <div class="bar-item"><div class="bar-label-value"><span class="label">Input NAS-F1:</span><span class="value-text" id="originalNasValText">-</span></div><div class="bar-wrapper"><div class="bar" id="originalNasBar" style="width: 0%;"></div></div></div>
                        <div class="bar-item"><div class="bar-label-value"><span class="label font-bold text-lg text-teal-800">Final Regularized NAS:</span><span class="value-text font-bold text-lg" id="regularizedNasValText">-</span></div><div class="bar-wrapper"><div class="bar" id="regularizedNasBar" style="width: 0%;"></div></div></div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-1">
                <div class="sticky top-6 space-y-6">
                    <div id="tour-step-3" class="demo-card interactive-card rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-slate-800 mb-4 flex items-center"><i class="fas fa-th text-teal-600 mr-2"></i>Configuration</h3>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <label for="refLenInput" class="text-sm font-medium text-slate-700">Reference Chunks (TR):</label>
                                <input type="number" id="refLenInput" min="1" max="50" value="9" class="w-20 text-center text-sm neumorphic-input">
                            </div>
                            <div class="flex items-center justify-between">
                                <label for="genLenInput" class="text-sm font-medium text-slate-700">Generated Chunks (TG):</label>
                                <input type="number" id="genLenInput" min="1" max="50" value="9" class="w-20 text-center text-sm neumorphic-input">
                            </div>
                            <div class="flex items-center justify-between">
                                <label for="nasF1Input" class="text-sm font-medium text-slate-700">Input NAS-F1 Score:</label>
                                <input type="number" id="nasF1Input" min="0" max="1" step="0.01" value="0.85" class="w-20 text-center text-sm neumorphic-input">
                            </div>
                        </div>
                    </div>

                    <div id="tour-step-5" class="demo-card interactive-card rounded-xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-slate-800 flex items-center"><i class="fas fa-magic text-purple-600 mr-2"></i>Test Scenarios</h3>
                            <button id="testing-guide-btn" class="neumorphic-btn primary px-3 py-1.5 text-xs">
                                <i class="fas fa-clipboard-check mr-1"></i>Testing Guide
                            </button>
                        </div>
                        <div class="space-y-3">
                            <button class="preset-btn w-full text-white px-4 py-2 rounded-xl text-sm font-medium" onclick="setScenario(9, 9, 0.85)"><i class="fas fa-equals mr-2"></i>Balanced (9√ó9)</button>
                            <button class="preset-btn w-full text-white px-4 py-2 rounded-xl text-sm font-medium" onclick="setScenario(25, 5, 0.85)"><i class="fas fa-arrows-alt-h mr-2"></i>Wide Ratio (25√ó5)</button>
                            <button class="preset-btn w-full text-white px-4 py-2 rounded-xl text-sm font-medium" onclick="setScenario(5, 25, 0.85)"><i class="fas fa-arrows-alt-v mr-2"></i>Tall Ratio (5√ó25)</button>
                            <button class="preset-btn w-full text-white px-4 py-2 rounded-xl text-sm font-medium" onclick="setScenario(50, 20, 0.85)"><i class="fas fa-arrows-alt-h mr-2"></i>Ratio 5:2 (50√ó20)</button>
                            <button class="preset-btn w-full text-white px-4 py-2 rounded-xl text-sm font-medium" onclick="setScenario(25, 10, 0.85)"><i class="fas fa-arrows-alt-h mr-2"></i>Ratio 5:2 (25√ó10)</button>
                        </div>
                    </div>

                    <div id="tour-step-6" class="metrics-card interactive-card rounded-xl p-6">
                        <h3 class="text-lg font-semibold text-blue-800 mb-4 flex items-center"><i class="fas fa-info-circle text-blue-600 mr-2"></i>Quick Stats</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-slate-600">Coverage Ratio:</span>
                                <span id="coverageRatioText" class="font-semibold text-slate-800">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-600">Penalty Level:</span>
                                <span id="penaltyLevelText" class="font-semibold text-slate-800">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-slate-600">Score Impact:</span>
                                <span id="scoreImpactText" class="font-semibold text-slate-800">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    </div>
    </div>

    <!-- Testing Modal -->
    <div id="testing-modal" class="testing-modal">
        <div class="testing-modal-content">
            <div class="testing-modal-header">
                <h2 class="text-xl font-bold text-slate-800 flex items-center">
                    <i class="fas fa-clipboard-check mr-2 text-teal-600"></i>
                    Window Regularizer Testing Guide
                </h2>
                <button id="testing-modal-close" class="testing-modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="testing-content">
                <!-- Getting Started -->
                <div class="test-category">
                    <h3><i class="fas fa-play-circle"></i>Getting Started</h3>
                    <div class="test-item">
                        <h4>Understanding Window Regularizer Behavior</h4>
                        <p>This guide will help you understand how the Window Regularizer penalizes excessive mapping window coverage in different scenarios.</p>
                        <ul class="test-checklist">
                            <li>The regularizer measures window coverage relative to total grid area</li>
                            <li>Higher penalties are applied when windows cover too much of the grid</li>
                            <li>The penalty reduces the final NAS score to ensure fair assessment</li>
                            <li>Close this guide and use the Test Scenarios to experiment with different configurations</li>
                        </ul>
                    </div>
                </div>

                <!-- Balanced Scenario -->
                <div class="test-category">
                    <h3><i class="fas fa-equals"></i>Balanced Grid (9√ó9)</h3>
                    <div class="test-item">
                        <h4>What to Notice</h4>
                        <p>When both sequences have the same length, the regularizer should apply minimal penalty since the mapping windows are optimally sized.</p>
                        <ul class="test-checklist">
                            <li>Windows cover a small, reasonable portion of the total area</li>
                            <li>Coverage ratio should be close to the minimum area threshold</li>
                            <li>Penalty should be very low or zero</li>
                            <li>Final regularized score should be close to the original NAS score</li>
                        </ul>
                        <p class="text-sm text-slate-600 mt-2 italic">Close this guide and click "Balanced (9√ó9)" to see this in action.</p>
                    </div>
                </div>

                <!-- Wide Ratio Scenarios -->
                <div class="test-category">
                    <h3><i class="fas fa-arrows-alt-h"></i>Wide Ratios (Imbalanced)</h3>
                    <div class="test-item">
                        <h4>What to Notice</h4>
                        <p>When one sequence is much longer than the other, mapping windows become oversized, triggering regularization penalties.</p>
                        <ul class="test-checklist">
                            <li>Windows cover a large portion of the total grid area</li>
                            <li>Coverage ratio significantly exceeds the minimum threshold</li>
                            <li>Penalty increases as the ratio becomes more extreme</li>
                            <li>Final score is substantially reduced from the original NAS</li>
                            <li>More extreme ratios (50√ó20) produce higher penalties than moderate ones (25√ó10)</li>
                        </ul>
                        <p class="text-sm text-slate-600 mt-2 italic">Close this guide and try "Wide Ratio (25√ó5)" then "Ratio 5:2 (50√ó20)" to compare penalty levels.</p>
                    </div>
                </div>

                <!-- Tall Ratio Scenarios -->
                <div class="test-category">
                    <h3><i class="fas fa-arrows-alt-v"></i>Tall Ratios (Vertical Imbalance)</h3>
                    <div class="test-item">
                        <h4>What to Notice</h4>
                        <p>Similar to wide ratios but with the reference text being much longer than the generated text.</p>
                        <ul class="test-checklist">
                            <li>Behavior is symmetric to wide ratios due to the max() function in min_area calculation</li>
                            <li>Penalty levels should be similar to equivalent wide ratios</li>
                            <li>The regularizer treats both axis imbalances equally</li>
                            <li>Score reduction follows the same pattern as wide scenarios</li>
                        </ul>
                        <p class="text-sm text-slate-600 mt-2 italic">Close this guide and click "Tall Ratio (5√ó25)" to see vertical imbalance effects.</p>
                    </div>
                </div>

                                <!-- Area-Based vs Ratio-Based Penalty -->
                <div class="test-category">
                    <h3><i class="fas fa-balance-scale"></i>Area-Based vs Ratio-Based Penalty</h3>
                    <div class="test-item">
                        <h4>Understanding the Core Distinction</h4>
                        <p>Window Regularizer uses area-based penalties, not ratio-based penalties. This crucial difference allows for fair assessment across different text scales while still penalizing unfair advantages.</p>
                        <ul class="test-checklist">
                            <li><strong>Both "Ratio 5:2" scenarios have identical chunk ratios</strong> (50√∑20 = 2.5 and 25√∑10 = 2.5)</li>
                            <li><strong>However, their penalty levels differ significantly</strong> because regularizer examines total window area</li>
                            <li><strong>This permits natural text length variations</strong> without heavily penalizing brief vs descriptive content</li>
                            <li><strong>Only truly unfair coverage excess triggers penalties</strong> ensuring genuine narrative alignment quality</li>
                        </ul>
                        <p class="text-sm text-slate-600 mt-2 italic">Close this guide and compare "Ratio 5:2 (25√ó10)" with "Ratio 5:2 (50√ó20)" to see area-based penalties in action.</p>
                    </div>
                </div>

                <!-- Interactive Exploration -->
                <div class="test-category">
                    <h3><i class="fas fa-hand-pointer"></i>Interactive Exploration</h3>
                    <div class="test-item">
                        <h4>Experiment with Parameters</h4>
                        <p>Use the interactive chart and controls to explore how different parameters affect regularization.</p>
                        <ul class="test-checklist">
                            <li>Drag the chart edges to resize the grid and observe real-time penalty changes</li>
                            <li>Adjust the NAS-F1 input to see how different base scores are affected</li>
                            <li>Try extreme ratios like 50√ó2 or 2√ó50 to see maximum penalties</li>
                            <li>Notice how the penalty bar turns red when coverage is excessive</li>
                            <li>Hover over the penalty bar to see visual feedback on the chart</li>
                        </ul>
                    </div>
                </div>

                <!-- Key Insights -->
                <div class="test-category">
                    <h3><i class="fas fa-lightbulb"></i>Key Insights</h3>
                    <div class="test-item">
                        <h4>What You Should Understand</h4>
                        <p>After exploring the different scenarios, you should understand these core principles:</p>
                        <ul class="test-checklist">
                            <li>The regularizer prevents artificially high scores in unbalanced text comparisons</li>
                            <li>Penalty increases non-linearly as window coverage exceeds optimal thresholds</li>
                            <li>Balanced comparisons receive minimal or no penalties</li>
                            <li>Extreme length imbalances result in substantial score reductions</li>
                            <li>The regularizer ensures fairness across different text length scenarios</li>
                            <li>Live calculations help you understand the mathematical relationships</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
                </main>
            </article>
        </div>
    </div>

    <script>
        const chartContainer = document.getElementById('chartContainer');
        const chartGrid = document.getElementById('chartGrid');
        const idealMappingContainer = document.getElementById('idealMappingContainer');
        const axisLabelContainerX = document.getElementById('axisLabelContainerX');
        const axisLabelContainerY = document.getElementById('axisLabelContainerY');
        const refLenInput = document.getElementById('refLenInput');
        const genLenInput = document.getElementById('genLenInput');
        const nasF1Input = document.getElementById('nasF1Input');
        const appBackground = document.getElementById('app-background');
        
        const timelineAreaValText = document.getElementById('timelineAreaValText'), 
              totalMappingWindowAreaValText = document.getElementById('totalMappingWindowAreaValText'), 
              minAreaValText = document.getElementById('minAreaValText'), 
              windowRegularizerValText = document.getElementById('windowRegularizerValText'), 
              originalNasValText = document.getElementById('originalNasValText'), 
              regularizedNasValText = document.getElementById('regularizedNasValText');
              
        const timelineAreaBar = document.getElementById('timelineAreaBar'), 
              totalMappingWindowAreaBar = document.getElementById('totalMappingWindowAreaBar'), 
              minAreaBar = document.getElementById('minAreaBar'), 
              windowRegularizerBar = document.getElementById('windowRegularizerBar'), 
              originalNasBar = document.getElementById('originalNasBar'), 
              regularizedNasBar = document.getElementById('regularizedNasBar');
              
        const coverageRatioText = document.getElementById('coverageRatioText'), 
              penaltyLevelText = document.getElementById('penaltyLevelText'), 
              scoreImpactText = document.getElementById('scoreImpactText');

        const testingGuideBtn = document.getElementById('testing-guide-btn');
        const testingModal = document.getElementById('testing-modal');
        const testingModalClose = document.getElementById('testing-modal-close');
              
        let numUnitsY, numUnitsX, currentPrecisionWindowsForRendering;
        
        const MAX_CHUNKS = 50;
        refLenInput.max = MAX_CHUNKS;
        genLenInput.max = MAX_CHUNKS;

        // --- TOUR MANAGER ---
        const tourManager = {
            isActive: false,
            currentStep: 0,
            overlay: document.getElementById('tour-overlay'),
            steps: [
                { selector: '#tour-step-intro', text: 'Welcome to Window Regularizer! This demo solves the problem where unbalanced text lengths create unfairly large alignment windows. Visit Distance-NAS and Line-NAS demos first to understand the foundational concepts.', position: 'bottom' },
                { selector: '#tour-step-algo', text: 'Click to expand the algorithm breakdown. This shows the 3-step mathematical theory behind window regularization penalties.', position: 'bottom' },
                { selector: '#tour-step-2', text: 'This chart shows your mapping windows as blue rectangles. Drag the right or top edges of the chart (hover to see them) to resize the grid and watch the coverage percentage change.', position: 'top' },
                { selector: '#tour-step-3', text: 'Use these controls to set grid dimensions. Values auto-update when you drag chart edges, or type directly to test specific scenarios. Try 25√ó10 vs 50√ó20 to see area-based penalties in action.', position: 'left' },
                { selector: '#tour-step-4', text: 'The red penalty bar shows regularization strength. Hover over it to highlight the penalized area on the grid. Bar intensity increases as window coverage becomes excessive.', position: 'top' },
                { selector: '#tour-step-5', text: 'Try these preset scenarios to explore different penalty cases. Compare the two "Ratio 5:2" buttons to see why identical ratios can have different penalties. Use Testing Guide for detailed explanations.', position: 'left' },
                { selector: '#tour-step-6', text: 'Live stats show coverage ratio (window area %), penalty level (regularization strength), and score impact (final effect on NAS). All values update instantly as you modify the grid.', position: 'left' }
            ],

            start: function() { this.isActive = true; this.currentStep = 0; this.overlay.style.pointerEvents = 'auto'; this.overlay.style.opacity = '1'; this.addClickOutsideHandler(); this.showStep(); },
            next: function() {
                this.cleanupCurrentStep(); this.currentStep++;
                if (this.currentStep < this.steps.length) {
                    if (this.steps[this.currentStep - 1].action) { this.steps[this.currentStep - 1].action(); }
                    setTimeout(() => this.showStep(), 400);
                } else { this.end(); }
            },
            showStep: function() {
                const step = this.steps[this.currentStep]; const targetElement = document.querySelector(step.selector); if (!targetElement) { this.end(); return; }
                targetElement.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
                setTimeout(() => {
                    targetElement.classList.add('tour-highlight');
                    // Special highlighting for configuration step (step index 2) which mentions dragging chart edges
                    if (this.currentStep === 2) {
                        const resizeHandleX = document.getElementById('resizeHandleX');
                        const resizeHandleY = document.getElementById('resizeHandleY');
                        if (resizeHandleX) resizeHandleX.style.opacity = '1';
                        if (resizeHandleY) resizeHandleY.style.opacity = '1';
                    }
                    const callout = document.createElement('div'); callout.id = 'tour-callout'; callout.innerHTML = `<p class="text-sm mb-4">${step.text}</p><div class="flex justify-end"><button onclick="tourManager.next()">Next &rarr;</button></div>`; document.body.appendChild(callout);
                    const targetRect = targetElement.getBoundingClientRect(); const calloutRect = callout.getBoundingClientRect(); const margin = 15;
                    const scrollY = window.scrollY || document.documentElement.scrollTop; const scrollX = window.scrollX || document.documentElement.scrollLeft;
                    let top, left;
                    switch (step.position) {
                        case 'bottom': top = targetRect.bottom + scrollY + margin; left = targetRect.left + scrollX + (targetRect.width / 2) - (calloutRect.width / 2); break;
                        case 'top': top = targetRect.top + scrollY - calloutRect.height - margin; left = targetRect.left + scrollX + (targetRect.width / 2) - (calloutRect.width / 2); break;
                        case 'left': top = targetRect.top + scrollY + (targetRect.height / 2) - (calloutRect.height / 2); left = targetRect.left + scrollX - calloutRect.width - margin; break;
                        case 'right': top = targetRect.top + scrollY + (targetRect.height / 2) - (calloutRect.height / 2); left = targetRect.right + scrollX + margin; break;
                        default: top = targetRect.bottom + scrollY + margin; left = targetRect.left + scrollX;
                    }
                    const viewportRight = scrollX + window.innerWidth; const viewportBottom = scrollY + window.innerHeight;
                    if (left < scrollX + margin) left = scrollX + margin;
                    if (left + calloutRect.width > viewportRight - margin) left = viewportRight - calloutRect.width - margin;
                    if (top < scrollY + margin) top = scrollY + margin;
                    if (top + calloutRect.height > viewportBottom - margin) top = viewportBottom - calloutRect.height - margin;
                    callout.style.top = `${top}px`; callout.style.left = `${left}px`;
                    requestAnimationFrame(() => { callout.classList.add('visible'); });
                }, 350);
            },
            cleanupCurrentStep: function() { 
                const oldHighlight = document.querySelector('.tour-highlight'); 
                if (oldHighlight) oldHighlight.classList.remove('tour-highlight'); 
                const oldCallout = document.getElementById('tour-callout'); 
                if (oldCallout) oldCallout.remove(); 
                // Clean up resize handle highlighting
                const resizeHandleX = document.getElementById('resizeHandleX');
                const resizeHandleY = document.getElementById('resizeHandleY');
                if (resizeHandleX) resizeHandleX.style.opacity = '';
                if (resizeHandleY) resizeHandleY.style.opacity = '';
            },
            end: function() { this.cleanupCurrentStep(); this.isActive = false; this.overlay.style.opacity = '0'; this.removeClickOutsideHandler(); setTimeout(() => this.overlay.style.pointerEvents = 'none', 400); },
            addClickOutsideHandler: function() { this.clickOutsideHandler = (e) => { if (this.isActive) { const callout = document.getElementById('tour-callout'); if (callout && !callout.contains(e.target)) { this.end(); } } }; document.addEventListener('click', this.clickOutsideHandler); },
            removeClickOutsideHandler: function() { if (this.clickOutsideHandler) { document.removeEventListener('click', this.clickOutsideHandler); this.clickOutsideHandler = null; } }
        };

        // --- Core Logic (Unchanged) ---
        function get_mapping_windows_js(refLen, genLen) {
            const isRefLonger = refLen >= genLen; const longerLen = isRefLonger ? refLen : genLen; const shorterLen = isRefLonger ? genLen : refLen;
            if (shorterLen === 0) return { precision_windows_for_rendering: [], windows_for_regularizer_calc: [], longer_axis_len: longerLen };
            const slope = longerLen / shorterLen; const mappingWindowHeight = Math.ceil(slope);
            let direct_windows = Array.from({length: shorterLen}, (_, i) => { const idx_point = i * slope, start = Math.max(Math.floor(idx_point), 0), end = Math.min(start + mappingWindowHeight, longerLen); return {start, end}; });
            let precision_windows_for_gen_chunks;
            if (isRefLonger) {
                precision_windows_for_gen_chunks = direct_windows.map(w => ({...w}));
            } else {
                precision_windows_for_gen_chunks = [];
                for (let genIdx = 0; genIdx < genLen; genIdx++) {
                    let mappedRefIndices = [];
                    direct_windows.forEach((ref_window_on_gen_axis, refIdx) => { if (genIdx >= ref_window_on_gen_axis.start && genIdx < ref_window_on_gen_axis.end) { mappedRefIndices.push(refIdx); } });
                    if (mappedRefIndices.length > 0) { precision_windows_for_gen_chunks.push({ start: Math.min(...mappedRefIndices), end: Math.max(...mappedRefIndices) + 1 });
                    } else { const proportionalRefPos = Math.floor((genIdx / genLen) * refLen); precision_windows_for_gen_chunks.push({ start: proportionalRefPos, end: proportionalRefPos + 1}); }
                }
            }
            return { precision_windows_for_rendering: precision_windows_for_gen_chunks, windows_for_regularizer_calc: direct_windows, longer_axis_len: longerLen };
        }
        function _calculate_window_regularizer_js(ref_len, gen_len, mapping_windows, max_len) {
            let total_mapping_window_area = 0; for (const window of mapping_windows) { total_mapping_window_area += (window.end - window.start); }
            const timeline_area = ref_len * gen_len; const min_area_val = max_len > 0 ? 1 / max_len : 0; let window_regularizer_val;
            if (timeline_area > 0 && min_area_val < 0.5 && (0.5 - min_area_val) > 1e-9) {
                window_regularizer_val = ((total_mapping_window_area / timeline_area) - min_area_val) / (0.5 - min_area_val);
                window_regularizer_val = Math.max(0, Math.min(1, window_regularizer_val));
            } else if (timeline_area > 0 && min_area_val >= 0.5) {
                window_regularizer_val = (total_mapping_window_area / timeline_area <= min_area_val + 1e-9) ? 0 : 1;
            } else { window_regularizer_val = 0; }
            return { window_regularizer: window_regularizer_val, internals: { total_mapping_window_area, timeline_area, min_area: min_area_val } };
        }
        function _regularize_nas_js(nas_f1, window_regularizer) {
            const nas_regularized = nas_f1 - window_regularizer; if (nas_regularized <= 0) return 0.0;
            if (Math.abs(1 - window_regularizer) < 1e-9) return 0.0;
            return nas_regularized / (1 - window_regularizer);
        }

        // --- Rendering & UI Update Functions ---
        function renderGridLines() {
            const container = chartGrid;
            container.querySelectorAll('.grid-line').forEach(e => e.remove());
            
            for (let i = 0; i <= numUnitsX; i++) {
                const line = document.createElement('div');
                line.className = 'grid-line';
                line.style.left = `${i / numUnitsX * 100}%`;
                line.style.top = '0';
                line.style.width = '1px';
                line.style.height = '100%';
                container.appendChild(line);
            }
            
            for (let i = 0; i <= numUnitsY; i++) {
                const line = document.createElement('div');
                line.className = 'grid-line';
                line.style.left = '0';
                line.style.top = `${i / numUnitsY * 100}%`;
                line.style.width = '100%';
                line.style.height = '1px';
                container.appendChild(line);
            }
        }
        
        function setScenario(ref, gen, nasF1) { refLenInput.value = ref; genLenInput.value = gen; nasF1Input.value = nasF1.toFixed(2); initializeStateAndRender(); }
        function updateGridBackground() { 
            if (numUnitsX > 0 && numUnitsY > 0) { 
                renderGridLines(); 
            } 
        }
        function renderIdealMappingWindows() {
            if (!currentPrecisionWindowsForRendering || numUnitsX === 0 || numUnitsY === 0) return;
            
            // Apply element reuse strategy for smooth transitions
            const existingWindows = Array.from(idealMappingContainer.children);
            
            currentPrecisionWindowsForRendering.forEach((windowData, gen_chunk_idx) => {
                if (gen_chunk_idx >= numUnitsX) return;
                
                // Reuse existing window or create new one
                let idealWindowDiv = existingWindows[gen_chunk_idx];
                if (!idealWindowDiv) {
                    idealWindowDiv = document.createElement('div'); 
                    idealWindowDiv.className = 'ideal-mapping-window';
                    idealMappingContainer.appendChild(idealWindowDiv);
                }
                
                // Update position and size - CSS transitions handle the animation
                idealWindowDiv.style.left = `calc(${gen_chunk_idx} * 100% / ${numUnitsX})`;
                idealWindowDiv.style.width = `calc(100% / ${numUnitsX})`;
                idealWindowDiv.style.bottom = `calc(${windowData.start} * 100% / ${numUnitsY})`;
                idealWindowDiv.style.height = `calc(${(windowData.end - windowData.start)} * 100% / ${numUnitsY})`;
            });
            
            // Remove extra windows
            while (idealMappingContainer.children.length > currentPrecisionWindowsForRendering.length) {
                idealMappingContainer.lastChild.remove();
            }
        }
        function renderAxisLabels() {
            if (numUnitsX === 0 || numUnitsY === 0) return;
            
            // Clear and rebuild axis labels (they change frequently with different step sizes)
            // For axis labels, clearing is more efficient than complex reuse logic
            axisLabelContainerX.innerHTML = ''; 
            axisLabelContainerY.innerHTML = '';
            
            const maxX = numUnitsX - 1, maxY = numUnitsY - 1; 
            const yStep = Math.max(1, Math.floor(numUnitsY / 10)) || 1; 
            const xStep = Math.max(1, Math.floor(numUnitsX / 10)) || 1;
            
            // Y-axis labels
            for (let i = 0; i <= maxY; i += yStep) { 
                const l = document.createElement('div'); 
                l.className = 'axis-label'; 
                l.textContent = i; 
                l.style.left = '-28px'; 
                l.style.bottom = `calc(${i}*100%/${numUnitsY} + 50%/${numUnitsY})`;
                l.style.transform = 'translateY(50%)'; 
                axisLabelContainerY.appendChild(l); 
            }
            if (maxY > 0 && (maxY % yStep !== 0 || (numUnitsY <= 10 && numUnitsY > 1))) { 
                const l = document.createElement('div'); 
                l.className = 'axis-label'; 
                l.dataset.value = maxY; 
                l.textContent = maxY; 
                l.style.left = '-28px'; 
                l.style.bottom = `calc(${maxY}*100%/${numUnitsY} + 50%/${numUnitsY})`;
                l.style.transform = 'translateY(50%)'; 
                axisLabelContainerY.appendChild(l); 
            }
            
            // X-axis labels
            for (let i = 0; i <= maxX; i += xStep) { 
                const l = document.createElement('div'); 
                l.className = 'axis-label'; 
                l.textContent = i; 
                l.style.bottom = '-25px'; 
                l.style.left = `calc(${i}*100%/${numUnitsX} + 50%/${numUnitsX})`;
                l.style.transform = 'translateX(-50%)'; 
                axisLabelContainerX.appendChild(l); 
            }
            if (maxX > 0 && (maxX % xStep !== 0 || (numUnitsX <= 10 && numUnitsX > 1))) { 
                const l = document.createElement('div'); 
                l.className = 'axis-label'; 
                l.dataset.value = maxX; 
                l.textContent = maxX; 
                l.style.bottom = '-25px'; 
                l.style.left = `calc(${maxX}*100%/${numUnitsX} + 50%/${numUnitsX})`;
                l.style.transform = 'translateX(-50%)'; 
                axisLabelContainerX.appendChild(l); 
            }
        }
        function updateDynamicBackground(finalScore) {
            const score = isNaN(finalScore) ? 0 : finalScore;
            // Use consistent greyish background like VCS demo
            appBackground.style.background = `linear-gradient(135deg, hsl(170, 20%, 90%) 0%, hsl(190, 30%, 95%) 100%)`;
        }
        function updateLiveCalculations(internals, regularizer, nasF1, regularizedNas) {
            const currentRegularizerMath = document.getElementById('currentRegularizerMath');
            if (currentRegularizerMath) {
                const coverageRatio = internals.timeline_area > 0 ? internals.total_mapping_window_area / internals.timeline_area : 0;
                let mathHtml = `<strong>Coverage Ratio:</strong> ${internals.total_mapping_window_area}/${internals.timeline_area} = ${coverageRatio.toFixed(3)}<br>`;
                mathHtml += `<strong>Min Area:</strong> 1/max(${numUnitsY},${numUnitsX}) = ${internals.min_area.toFixed(3)}<br>`;
                if (internals.min_area < 0.5) {
                    mathHtml += `<strong>Penalty:</strong> (${coverageRatio.toFixed(3)} - ${internals.min_area.toFixed(3)}) / (0.5 - ${internals.min_area.toFixed(3)}) = ${regularizer.toFixed(3)}<br>`;
                } else {
                    mathHtml += `<strong>Penalty:</strong> Edge case (min_area ‚â• 0.5) = ${regularizer.toFixed(3)}<br>`;
                }
                mathHtml += `<strong>Final:</strong> (${nasF1.toFixed(3)} - ${regularizer.toFixed(3)}) / (1 - ${regularizer.toFixed(3)}) = ${regularizedNas.toFixed(3)}`;
                currentRegularizerMath.innerHTML = mathHtml;
            }
        }

        function renderBarGraphs(internals, regularizer, nasF1, regularizedNas) {
            timelineAreaValText.textContent = internals.timeline_area.toFixed(0); totalMappingWindowAreaValText.textContent = internals.total_mapping_window_area.toFixed(0);
            minAreaValText.textContent = internals.min_area.toFixed(3); windowRegularizerValText.textContent = regularizer.toFixed(3);
            originalNasValText.textContent = nasF1.toFixed(3); regularizedNasValText.textContent = regularizedNas.toFixed(3);
            timelineAreaBar.style.width = internals.timeline_area > 0 ? '100%' : '0%';
            const tmwaRatio = internals.timeline_area > 0 ? (internals.total_mapping_window_area / internals.timeline_area) * 100 : 0;
            totalMappingWindowAreaBar.style.width = `${Math.min(100, Math.max(0, tmwaRatio))}%`; minAreaBar.style.width = `${Math.min(100, Math.max(0, internals.min_area * 100))}%`;
            windowRegularizerBar.style.width = `${Math.min(100, Math.max(0, regularizer * 100))}%`; originalNasBar.style.width = `${Math.min(100, Math.max(0, nasF1 * 100))}%`;
            regularizedNasBar.style.width = `${Math.min(100, Math.max(0, regularizedNas * 100))}%`;
            const coverageRatio = internals.timeline_area > 0 ? internals.total_mapping_window_area / internals.timeline_area : 0;
            coverageRatioText.textContent = `${(coverageRatio * 100).toFixed(1)}%`; let penaltyLevel = 'None';
            if (regularizer > 0.7) penaltyLevel = 'High'; else if (regularizer > 0.4) penaltyLevel = 'Medium'; else if (regularizer > 0.1) penaltyLevel = 'Low';
            penaltyLevelText.textContent = penaltyLevel; const scoreImpact = nasF1 - regularizedNas;
            scoreImpactText.textContent = `${scoreImpact >= 0 ? '‚àí' : '+'}${Math.abs(scoreImpact).toFixed(3)}`;
            scoreImpactText.style.color = scoreImpact > 0 ? '#ef4444' : (scoreImpact < 0 ? '#10b981' : '#475569');
            
            // Update live calculations
            updateLiveCalculations(internals, regularizer, nasF1, regularizedNas);
        }

        // --- Testing Modal Manager ---
        const testingModalManager = {
            open: function() {
                testingModal.classList.add('visible');
                document.body.style.overflow = 'hidden';
            },
            close: function() {
                testingModal.classList.remove('visible');
                document.body.style.overflow = 'auto';
            },
            toggle: function() {
                if (testingModal.classList.contains('visible')) {
                    this.close();
                } else {
                    this.open();
                }
            }
        };
        
        // --- Main State & Render Orchestrator ---
        function initializeStateAndRender() {
            numUnitsY = Math.max(1, Math.min(MAX_CHUNKS, parseInt(refLenInput.value, 10) || 1));
            numUnitsX = Math.max(1, Math.min(MAX_CHUNKS, parseInt(genLenInput.value, 10) || 1));
            refLenInput.value = numUnitsY; genLenInput.value = numUnitsX;
            const dummyNasF1 = parseFloat(nasF1Input.value) || 0; nasF1Input.value = dummyNasF1.toFixed(2);
            
            const mappingData = get_mapping_windows_js(numUnitsY, numUnitsX);
            currentPrecisionWindowsForRendering = mappingData.precision_windows_for_rendering;
            
            const regularizerResult = _calculate_window_regularizer_js(numUnitsY, numUnitsX, mappingData.windows_for_regularizer_calc, mappingData.longer_axis_len);
            const regularizedNas = _regularize_nas_js(dummyNasF1, regularizerResult.window_regularizer);
            
            requestAnimationFrame(() => {
                updateGridBackground(); renderIdealMappingWindows(); renderAxisLabels();
                renderBarGraphs(regularizerResult.internals, regularizerResult.window_regularizer, dummyNasF1, regularizedNas);
                updateDynamicBackground(regularizedNas);
            });

            if (window.renderMathInElement) { renderMathInElement(document.body, { delimiters: [ {left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false} ] }); }
        }
        
        // --- Event Listeners & Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Standard input listeners
            refLenInput.addEventListener('input', initializeStateAndRender);
            genLenInput.addEventListener('input', initializeStateAndRender);
            nasF1Input.addEventListener('input', initializeStateAndRender);
            window.addEventListener('resize', initializeStateAndRender);
            document.getElementById('start-tour-btn').addEventListener('click', () => tourManager.start());
            
            // Testing modal event listeners
            testingGuideBtn.addEventListener('click', () => testingModalManager.open());
            testingModalClose.addEventListener('click', () => testingModalManager.close());
            testingModal.addEventListener('click', (e) => {
                if (e.target === testingModal) {
                    testingModalManager.close();
                }
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && testingModal.classList.contains('visible')) {
                    testingModalManager.close();
                }
                if (e.key === 't' && e.ctrlKey) {
                    e.preventDefault();
                    testingModalManager.toggle();
                }
            });
            
            // Penalty Attribution Listener
            document.getElementById('penalty-bar-container').addEventListener('mouseover', () => {
                if (parseFloat(windowRegularizerValText.textContent) > 0) {
                    idealMappingContainer.classList.add('penalty-highlight-active');
                }
            });
            document.getElementById('penalty-bar-container').addEventListener('mouseout', () => {
                idealMappingContainer.classList.remove('penalty-highlight-active');
            });

            // Resizing Logic
            const handleX = document.getElementById('resizeHandleX');
            const handleY = document.getElementById('resizeHandleY');
            let isResizing = null;
            let startMousePos = { x: 0, y: 0 };
            let startValues = { genLen: 0, refLen: 0 };

            const handleResizeMouseDown = (e) => {
                isResizing = e.target.id === 'resizeHandleX' ? 'x' : 'y';
                document.body.style.cursor = isResizing === 'x' ? 'ew-resize' : 'ns-resize';
                document.body.style.userSelect = 'none';
                
                // Capture starting position and values
                startMousePos.x = e.clientX;
                startMousePos.y = e.clientY;
                startValues.genLen = parseInt(genLenInput.value, 10);
                startValues.refLen = parseInt(refLenInput.value, 10);
            };

            const handleResizeMouseMove = (e) => {
                if (!isResizing) return;
                
                // Calculate movement delta with sensitivity scaling
                const sensitivity = 0.1; // Adjust this to control drag sensitivity
                
                if (isResizing === 'x') {
                    const deltaX = e.clientX - startMousePos.x;
                    const deltaValue = Math.round(deltaX * sensitivity);
                    const newGenLen = startValues.genLen + deltaValue;
                    genLenInput.value = Math.max(1, Math.min(MAX_CHUNKS, newGenLen));
                } else { // isResizing === 'y'
                    const deltaY = startMousePos.y - e.clientY; // Inverted for intuitive up/down behavior
                    const deltaValue = Math.round(deltaY * sensitivity);
                    const newRefLen = startValues.refLen + deltaValue;
                    refLenInput.value = Math.max(1, Math.min(MAX_CHUNKS, newRefLen));
                }
                initializeStateAndRender();
            };
            
            const handleResizeMouseUp = () => {
                isResizing = null;
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
            };

            handleX.addEventListener('mousedown', handleResizeMouseDown);
            handleY.addEventListener('mousedown', handleResizeMouseDown);
            document.addEventListener('mousemove', handleResizeMouseMove);
            document.addEventListener('mouseup', handleResizeMouseUp);

            initializeStateAndRender();
        });

    </script>
</body>
</html>
